<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Gravity – iPad Light</title>
  <style>
    html,body{margin:0;height:100%;background:#000}
    #app{position:fixed;inset:0}
    #hud{position:fixed;left:8px;top:8px;color:#fff;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;font:12px/1.35 -apple-system,system-ui,Segoe UI,Roboto,sans-serif}
    #hud b{color:#aef}
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="hud">⌛ <b>Loading…</b></div>

  <!-- 軽量・互換重視：three.js のグローバル版のみを使用（OrbitControlsなし） -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script>
  (function(){
    const hud = document.getElementById('hud');
    const say = (t)=>{ hud.innerHTML = t; };

    try {
      if (!window.THREE) throw new Error('THREE not loaded');
      // WebGL 簡易チェック
      const test = document.createElement('canvas');
      const gl = test.getContext('webgl')||test.getContext('experimental-webgl');
      if (!gl) throw new Error('WebGL unavailable');

      // Renderer（負荷を下げる設定）
      const renderer = new THREE.WebGLRenderer({ antialias:false, alpha:false, powerPreference:'high-performance' });
      const app = document.getElementById('app');
      app.appendChild(renderer.domElement);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 1.25));

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 200);
      camera.position.set(0, 2.2, 6.5);

      // 簡易ライト
      scene.add(new THREE.AmbientLight(0x303030));
      const key = new THREE.PointLight(0xffffff, 1.0); key.position.set(3,4,2); scene.add(key);
      const rim = new THREE.PointLight(0x55aaff, 0.6); rim.position.set(-4,-2,-3); scene.add(rim);

      // 中心（青い球）
      const core = new THREE.Mesh(
        new THREE.SphereGeometry(1, 32, 32),
        new THREE.MeshStandardMaterial({ color:0x66ccff, metalness:0.25, roughness:0.35, emissive:0x082244 })
      );
      scene.add(core);

      // 粒子クラウド（超軽量：数とサブディビを小さく）
      const g = new THREE.SphereGeometry(0.028, 6, 6);
      const m = new THREE.MeshBasicMaterial({ color:0xfff2a8 });
      const group = new THREE.Group();
      const COUNT = 320; // ← ここを増減すると負荷が変わる
      for (let i=0;i<COUNT;i++){
        const p = new THREE.Mesh(g, m);
        const r = THREE.Math.randFloat(2.0, 5.2);
        const a = Math.random()*Math.PI*2;
        const e = Math.acos(THREE.Math.randFloatSpread(2));
        p.position.set(
          r*Math.sin(e)*Math.cos(a),
          r*Math.sin(e)*Math.sin(a),
          r*Math.cos(e)
        );
        group.add(p);
      }
      scene.add(group);

      // リサイズ
      function resize(){
        const w = window.innerWidth, h = window.innerHeight;
        renderer.setSize(w, h, false);
        camera.aspect = w/h; camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', resize); resize();

      // アニメ（超軽量：回転のみ）
      let paused = false;
      document.addEventListener('click', ()=>{ paused = !paused; say(paused?'⏸ Paused（タップで再開）':'▶︎ Running（タップで一時停止）'); });
      say('▶︎ Running（タップで一時停止）');

      function tick(){
        requestAnimationFrame(tick);
        if(!paused){
          group.rotation.y += 0.0009;
          group.rotation.x += 0.00025;
          core.rotation.y -= 0.0008;
        }
        renderer.render(scene, camera);
      }
      tick();

    } catch(err){
      console.error(err);
      say('❌ '+err.message+'<br>設定>バッテリー>低電力モードOFF / Safariを再起動して再度お試しください。');
    }
  })();
  </script>
</body>
</html>
