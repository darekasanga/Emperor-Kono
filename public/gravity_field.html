<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Gravity Field (iPad Safe)</title>
  <style>
    html,body{margin:0;height:100%;background:#000}
    #app{position:fixed;inset:0}
    #log{position:fixed;left:8px;top:8px;color:#fff;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;font:12px/1.3 -apple-system,system-ui,Segoe UI,Roboto,sans-serif;white-space:pre-wrap;max-width:80vw}
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="log">⌛ Loading…</div>

  <!-- ✅ iPadで安定しやすい「グローバル版」three.jsをCDNから読込み -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <script>
  (function(){
    const logEl = document.getElementById('log');
    const log = (m)=>{ logEl.textContent = String(m); };

    try {
      if (!window.THREE) { throw new Error('THREE not loaded'); }
      const c = document.createElement('canvas');
      const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
      if (!gl) { throw new Error('WebGL unavailable'); }

      const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
      const app = document.getElementById('app');
      app.appendChild(renderer.domElement);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 1.5));
      function resize(){
        renderer.setSize(window.innerWidth, window.innerHeight, false);
        camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
      }

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 200);
      camera.position.set(0,3.5,8);

      // lights
      scene.add(new THREE.AmbientLight(0x222222));
      const key = new THREE.PointLight(0xffffff, 1.2); key.position.set(3,4,2); scene.add(key);
      const rim = new THREE.PointLight(0x66ccff, .6); rim.position.set(-4,-2,-3); scene.add(rim);

      // core sphere
      const core = new THREE.Mesh(new THREE.SphereGeometry(1,48,48), new THREE.MeshStandardMaterial({color:0x66ccff, metalness:.3, roughness:.25, emissive:0x082244}));
      scene.add(core);

      // particles
      const g = new THREE.SphereGeometry(0.03,8,8);
      const m = new THREE.MeshBasicMaterial({ color:0xffffaa });
      const particles = new THREE.Group();
      for (let i=0;i<800;i++){
        const p = new THREE.Mesh(g, m);
        const r = THREE.Math.randFloat(2.0, 5.5);
        const a = Math.random()*Math.PI*2;
        const e = Math.acos(THREE.Math.randFloatSpread(2));
        p.position.set(
          r*Math.sin(e)*Math.cos(a),
          r*Math.sin(e)*Math.sin(a),
          r*Math.cos(e)
        );
        particles.add(p);
      }
      scene.add(particles);

      // arrows (field direction)
      const arrows = new THREE.Group();
      const dir = new THREE.Vector3();
      for (let i=0;i<20;i++){
        const th = i/20*Math.PI*2;
        for (let j=0;j<6;j++){
          const ph = j/6*Math.PI;
          const x = 2.2*Math.sin(ph)*Math.cos(th);
          const y = 2.2*Math.sin(ph)*Math.sin(th);
          const z = 2.2*Math.cos(ph);
          const from = new THREE.Vector3(x,y,z);
          dir.copy(from).multiplyScalar(-1).normalize();
          arrows.add(new THREE.ArrowHelper(dir, from, 0.8, 0x66ccff, 0.15, 0.08));
        }
      }
      scene.add(arrows);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = .05;

      window.addEventListener('resize', resize); resize();

      let t=0; log('✅ Loaded — drag to rotate / pinch to zoom | ▶︎/⏸ タップで停止');
// pause/play toggle
let paused=false; document.body.addEventListener('click',()=>{paused=!paused; log(paused?'⏸ Paused — 画面をタップで再開':'▶︎ Playing');});
      (function animate(){
        requestAnimationFrame(animate);
        if(!paused){ t+=0.005; particles.rotation.y += 0.0008; particles.rotation.x += 0.0003; core.rotation.y -= 0.001; }
controls.update(); renderer.render(scene,camera);
      })();

    } catch (e) {
      console.error(e); log('❌ Error: '+ e.message + '
Try: Settings > Safari > Advanced > Experimental Features > WebGL ON, then reload.');
    }
  })();
  </script>
</body>
</html>
